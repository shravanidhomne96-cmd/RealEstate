<template>
    <lightning-card title="Towers & Property Units" icon-name="custom:custom63">
        <!-- Loading state -->
        <template if:true={isLoading}>
            <div class="slds-is-relative slds-p-around_medium">
                <lightning-spinner alternative-text="Loading towers and units" size="medium"></lightning-spinner>
            </div>
        </template>

        <!-- Error state -->
        <template if:true={error}>
            <div class="slds-p-horizontal_medium slds-p-vertical_small">
                <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
                    <span class="slds-assistive-text">Error</span>
                    <lightning-icon icon-name="utility:error" size="x-small" class="slds-m-right_x-small" alternative-text="Error"></lightning-icon>
                    <span>{errorMessage}</span>
                </div>
            </div>
        </template>

        <!-- Empty state -->
        <template if:true={isEmpty}>
            <div class="slds-p-around_medium slds-align_absolute-center slds-text-align_center">
                <div class="slds-illustration slds-illustration_small">
                    <svg class="slds-illustration__svg" viewBox="0 0 454 340" aria-hidden="true">
                        <use xlink:href="/_slds/icons/utility-sprite/svg/symbols.svg#insert_template"></use>
                    </svg>
                    <div class="slds-text-heading_medium slds-m-top_small">No Towers Found</div>
                    <p class="slds-m-top_x-small slds-text-color_weak">There are no towers or units to display for this record.</p>
                </div>
            </div>
        </template>

        <!-- Content -->
        <template if:true={hasData}>
            <div class="slds-p-around_medium">
                <div class="slds-grid slds-wrap slds-gutters">
                    <template for:each={towers} for:item="tower">
                        <section key={tower.Id} class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-p-around_x-small">
                            <article class="slds-card slds-card_boundary tower-card">
                                <div class="slds-card__header slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                                    <header class="slds-media slds-media_center">
                                        <span class="slds-avatar slds-avatar_circle slds-avatar_medium slds-m-right_small tower-avatar" title={towerInitials}>
                                            <span class="slds-assistive-text">{tower.Name}</span>
                                        </span>
                                        <div class="slds-media__body">
                                            <h2 class="slds-card__header-title">
                                                <span class="slds-text-heading_small">{tower.Name}</span>
                                            </h2>
                                            <p class="slds-text-body_small slds-text-color_weak">
                                                <lightning-badge label={tower.unitCountLabel}></lightning-badge>
                                            </p>
                                        </div>
                                    </header>
                                </div>
                                <div class="slds-card__body slds-card__body_inner">
                                    <template if:true={tower.Property_Units__r}>
                                        <ul class="slds-has-dividers_around-space unit-list" role="list">
                                            <template for:each={tower.Property_Units__r} for:item="unit">
                                                <li key={unit.Id} class="slds-item unit-item">
                                                    <div class="slds-grid slds-wrap slds-grid_vertical-align-center">
                                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-3 slds-truncate" title={unit.Name}>
                                                            <lightning-icon icon-name="utility:home" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                            <span class="unit-name">{unit.Name}</span>
                                                            <!-- Unit details -->
                                                            <template if:true={unit.displayDetails}>
                                                                <span class="slds-text-color_weak slds-m-left_small">• Type: {unit.displayDetails.type}</span>
                                                                <span class="slds-text-color_weak slds-m-left_small">• Status: {unit.displayDetails.status}</span>
                                                                <span class="slds-text-color_weak slds-m-left_small">• Area: {unit.displayDetails.area}</span>
                                                            </template>
                                                        </div>
                                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-grid slds-grid_align-end slds-grid_vertical-align-center">
                                                            <lightning-badge label="Unit"></lightning-badge>
                                                            <template if:true={unit.Sub_Units__r}>
                                                                <lightning-badge class="slds-m-left_x-small" label={unit.subUnitCountLabel}></lightning-badge>
                                                            </template>
                                                        </div>
                                                    </div>

                                                    <!-- Sub Units -->
                                                    <template if:true={unit.Sub_Units__r}>
                                                        <div class="slds-m-top_x-small subunit-toggle">
                                                            <button class="slds-button slds-button_neutral slds-button_stretch" onclick={handleToggleSubUnits} data-unit-id={unit.Id}>
                                                                <template if:true={unit._expanded}>
                                                                    <lightning-icon icon-name="utility:chevrondown" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                                    <span>Hide Sub Units</span>
                                                                </template>
                                                                <template if:false={unit._expanded}>
                                                                    <lightning-icon icon-name="utility:chevronright" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                                    <span>Show Sub Units</span>
                                                                </template>
                                                            </button>
                                                        </div>
                                                        <template if:true={unit._expanded}>
                                                            <ul data-subunit-list-id={unit.Id} class="slds-has-dividers_around-space subunit-list slds-m-top_x-small" role="list">
                                                                <template for:each={unit.Sub_Units__r} for:item="su">
                                                                    <li key={su.Id} class="slds-item slds-grid slds-wrap slds-grid_vertical-align-center">
                                                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-3">
                                                                            <lightning-icon icon-name="utility:branch_merge" size="xx-small" class="slds-m-right_x-small"></lightning-icon>
                                                                            <span class="subunit-name slds-truncate" title={su.Name}>{su.Name}</span>
                                                                            <!-- Sub Unit details -->
                                                                            <template if:true={su.displayDetails}>
                                                                                <span class="slds-text-color_weak slds-m-left_small">• Type: {su.displayDetails.type}</span>
                                                                                <span class="slds-text-color_weak slds-m-left_small">• Status: {su.displayDetails.status}</span>
                                                                                <span class="slds-text-color_weak slds-m-left_small">• Area: {su.displayDetails.area}</span>
                                                                            </template>
                                                                        </div>
                                                                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-grid slds-grid_align-end">
                                                                            <lightning-badge label="Sub Unit"></lightning-badge>
                                                                        </div>
                                                                    </li>
                                                                </template>
                                                            </ul>
                                                        </template>
                                                    </template>
                                                </li>
                                            </template>
                                        </ul>
                                    </template>
                                    <template if:false={tower.Property_Units__r}>
                                        <div class="slds-p-vertical_small slds-text-color_weak slds-text-align_center">No units in this tower</div>
                                    </template>
                                </div>
                            </article>
                        </section>
                    </template>
                </div>
            </div>
        </template>
    </lightning-card>
</template>
